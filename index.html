<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LivLuv'd Brain Health Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .icon { width: 1.5rem; height: 1.5rem; display: inline-block; vertical-align: middle; }
        .icon-lg { width: 3rem; height: 3rem; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-1 > * + * { margin-top: 0.25rem; }
        .space-x-1 > * + * { margin-left: 0.25rem; }
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        .gap-4 { gap: 1rem; }
        @media (min-width: 768px) {
            .md\\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .md\\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }
        @media (min-width: 1024px) {
            .lg\\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-6xl mx-auto p-6 bg-white min-h-screen">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-4">
                <svg class="icon-lg text-blue-600 mr-3" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9.5 2A2.5 2.5 0 007 4.5v15A2.5 2.5 0 009.5 22h5a2.5 2.5 0 002.5-2.5v-15A2.5 2.5 0 0014.5 2h-5zM11 6h2v2h-2V6zm0 4h2v8h-2v-8z"/>
                </svg>
                <h1 class="text-4xl font-bold text-gray-800">LivLuv'd Brain Health Calculator</h1>
            </div>
            <p class="text-lg text-gray-600">LivLuv'd Performance-Based Assessment with Enhanced Evidence-Based Prescriptions</p>
            
            <!-- Share Calculator Section -->
            <div class="mt-6 p-4 bg-blue-50 rounded-lg no-print">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Share This Calculator</h3>
                <div class="flex flex-wrap justify-center gap-3">
                    <button id="copyLinkBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center text-sm">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                        Copy Link
                    </button>
                    <button id="shareEmailBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center text-sm">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                        Email
                    </button>
                    <button id="shareTwitterBtn" class="px-4 py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600 flex items-center text-sm">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z"/>
                        </svg>
                        Twitter
                    </button>
                </div>
                <div id="linkCopiedMsg" class="mt-2 text-sm text-green-600 font-medium hidden">✓ Link copied to clipboard!</div>
            </div>
        </div>

        <!-- Patient Information Form -->
        <div id="assessmentForm" class="space-y-6">
            <div class="bg-blue-50 p-6 rounded-lg">
                <h2 class="text-2xl font-semibold mb-4 flex items-center">
                    <svg class="icon mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Patient Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                        <input type="text" id="patientName" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Patient name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Age</label>
                        <input type="number" id="patientAge" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Age (45-90)" min="45" max="90">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
                        <select id="patientGender" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Physical Tests -->
            <div class="bg-green-50 p-6 rounded-lg">
                <h2 class="text-2xl font-semibold mb-4 flex items-center">
                    <svg class="icon mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
                    </svg>
                    Physical Performance Tests
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            TUG Test Time
                            <span class="text-xs text-gray-500 block">seconds (lower is better)</span>
                        </label>
                        <input type="number" id="tugTime" step="0.1" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 8.5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Gait Speed
                            <span class="text-xs text-gray-500 block">m/s (higher is better)</span>
                        </label>
                        <input type="number" id="gaitSpeed" step="0.01" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 1.25">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            6-Minute Walk Test
                            <span class="text-xs text-gray-500 block">meters (higher is better)</span>
                        </label>
                        <input type="number" id="sixMinWalk" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 450">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Grip Strength
                            <span class="text-xs text-gray-500 block">lbs (higher is better)</span>
                        </label>
                        <input type="number" id="gripStrength" step="0.1" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 56.2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            30s Sit-to-Stand
                            <span class="text-xs text-gray-500 block">repetitions (higher is better)</span>
                        </label>
                        <input type="number" id="sitToStand" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 15">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Single-Leg Balance
                            <span class="text-xs text-gray-500 block">seconds (higher is better)</span>
                        </label>
                        <input type="number" id="singleLegBalance" step="0.1" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 15.2">
                    </div>
                </div>
            </div>

            <!-- Cognitive Tests -->
            <div class="bg-purple-50 p-6 rounded-lg">
                <h2 class="text-2xl font-semibold mb-4 flex items-center">
                    <svg class="icon mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9.5 2A2.5 2.5 0 007 4.5v15A2.5 2.5 0 009.5 22h5a2.5 2.5 0 0017 19.5v-15A2.5 2.5 0 0014.5 2h-5zM11 6h2v2h-2V6zm0 4h2v8h-2v-8z"/>
                    </svg>
                    Cognitive Assessment
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            MoCA Score
                            <span class="text-xs text-gray-500 block">out of 30 (higher is better)</span>
                        </label>
                        <input type="number" id="mocaScore" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 26" min="0" max="30">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Neurotrak Symbol Match
                            <span class="text-xs text-gray-500 block">score (higher is better)</span>
                        </label>
                        <input type="number" id="neurotrakSymbol" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 85">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Neurotrak Path Points
                            <span class="text-xs text-gray-500 block">score (higher is better)</span>
                        </label>
                        <input type="number" id="neurotrakPath" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 92">
                    </div>
                </div>
            </div>

            <!-- Calculate Button -->
            <div class="text-center">
                <button id="calculateBtn" class="px-8 py-4 rounded-lg font-semibold text-lg flex items-center mx-auto bg-gray-300 text-gray-500 cursor-not-allowed" disabled>
                    <svg class="icon mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                    </svg>
                    Calculate LivLuv'd Performance Assessment
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="space-y-6 hidden">
            <!-- Results Header -->
            <div class="bg-blue-50 p-6 rounded-lg">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-semibold">Assessment Results for <span id="resultName"></span></h2>
                        <p class="text-gray-600">Age: <span id="resultAge"></span> | Gender: <span id="resultGender"></span> | Reference Group: <span id="resultAgeGroup"></span></p>
                        <p class="text-sm text-blue-600 mt-1">Performance-based physical assessment with cognitive impairment risk evaluation</p>
                    </div>
                    <div class="text-right">
                        <div id="compositeScore" class="text-3xl font-bold text-blue-600">--</div>
                        <div class="text-sm text-gray-600">Composite Score</div>
                    </div>
                </div>
            </div>

            <!-- Risk Level -->
            <div class="bg-white border-2 border-gray-200 rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <svg id="riskIcon" class="w-8 h-8 mr-3" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                        </svg>
                        <div>
                            <h3 class="text-xl font-semibold">Overall Risk Level</h3>
                            <p id="riskLevel" class="text-lg font-medium">-- Risk</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Domain Scores -->
            <div id="domainScores" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Domain score cards will be populated by JavaScript -->
            </div>

            <!-- Test Results Table -->
            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                <div class="bg-gray-50 px-6 py-4">
                    <h3 class="text-lg font-semibold">Individual Test Results</h3>
                    <p class="text-sm text-gray-600 mt-1">Physical tests graded using LivLuv'd performance criteria; MoCA uses cognitive impairment risk levels; Neurotrak uses clinical classification</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentile</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Interpretation</th>
                            </tr>
                        </thead>
                        <tbody id="testResultsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Test results will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Prescriptions -->
            <div id="prescriptionsSection" class="bg-white border border-gray-200 rounded-lg">
                <div class="bg-gray-50 px-6 py-4">
                    <h3 class="text-lg font-semibold">Enhanced Evidence-Based Intervention Prescription</h3>
                    <p class="text-sm text-gray-600 mt-1">Personalized recommendations based on latest 2024 clinical research and guidelines</p>
                </div>
                <div id="prescriptionsContent" class="p-6 space-y-6">
                    <!-- Prescriptions will be populated by JavaScript -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="bg-gray-50 p-6 rounded-lg no-print">
                <h3 class="text-lg font-semibold mb-4 text-center">Share & Export Results</h3>
                
                <!-- Export Options -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
                    <button id="exportBtn" class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                        </svg>
                        Export CSV
                    </button>
                    <button id="printBtn" class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                        </svg>
                        Print Results
                    </button>
                    <button id="shareResultsEmailBtn" class="px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                        Email Results
                    </button>
                    <button id="copyResultsBtn" class="px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                        Copy Summary
                    </button>
                </div>
                
                <!-- New Assessment Button -->
                <div class="text-center">
                    <button id="newAssessmentBtn" class="px-6 py-3 bg-blue-800 text-white rounded-lg hover:bg-blue-900 flex items-center justify-center mx-auto">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        New Assessment
                    </button>
                </div>
                
                <div id="resultsCopiedMsg" class="mt-3 text-sm text-green-600 font-medium text-center hidden">✓ Results summary copied to clipboard!</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let patientData = {};
        let results = {};

        // Katie's Exercise Progression Framework
        const exerciseProgressions = {
            tug: {
                'A': {
                    criteria: '< 8 seconds',
                    exercises: {
                        '-': ['Mini Goblet Squat', 'Bunny Hops'],
                        'main': ['Goblet Squats', 'Large Step Up (12+ in) with Knee Drives'],
                        '+': ['Walking with 360 degree Turns', 'Walking with Naming/Arithmetic and Directional Commands']
                    }
                },
                'B': {
                    criteria: '8 - 10 seconds',
                    exercises: {
                        '-': ['Weighted Sit to Stand', 'Counter Supported Bunny Hops'],
                        'main': ['Weighted Chair Touch', 'Lateral Step Ups (4-6 in) with Knee Drive'],
                        '+': ['Walking Shuttles (180 degree Turns)', 'Walking with Narrow Category Naming (fruits, capitals, birds)']
                    }
                },
                'C': {
                    criteria: '10 - 13 seconds',
                    exercises: {
                        '-': ['Box Assisted Sit to Stand', 'Bilateral Heel Raise Drops'],
                        'main': ['Arms Crossed Sit to Stand', 'Standard Step Ups (8-10 in)'],
                        '+': ['STS 180 degree Turns Between 2 Chairs', 'Walking with Broad Category Naming (foods, cities, animals)']
                    }
                },
                'D': {
                    criteria: '14 - 16 seconds',
                    exercises: {
                        '-': ['Counter Assisted Box Squat Wearing Weight', 'Counter Supported Marching Stomps'],
                        'main': ['Counter UE Assisted Squat', 'Low Step Up (4-6 in) with UE Assist'],
                        '+': ['Counter Walking with 180 degree Turns', 'Walking with Intermediate Arithmetic (add/subtract by 3/4s)']
                    }
                },
                'F': {
                    criteria: '> 16 seconds',
                    exercises: {
                        '-': ['Leg Press', 'Seated Stomps'],
                        'main': ['Counter UE Assist Box Squat', 'Counter Supported/Seated Step Taps'],
                        '+': ['Standing Quarter Turns in Corner', 'Walking with Simple Arithmetic (add/subtract by 1/2s)']
                    }
                }
            },
            gaitSpeed: {
                'A': {
                    criteria: '1.3 + m/s',
                    exercises: {
                        '-': ['Triple Extension at Wall', 'Forward/Backward Tandem Walking'],
                        'main': ['Speed Walking / Agility Ladder Stepping', 'Weighted Sled Pushes'],
                        '+': ['Blaze Pod Shuttle Foot Taps', 'Walking with Aqua Gym Carry']
                    }
                },
                'B': {
                    criteria: '1.1-1.2 m/s',
                    exercises: {
                        '-': ['Single Leg (Optional UE Support) Heel Raises', 'Forward Backward Walking'],
                        'main': ['Quick March Walking', 'Incline Walking on Treadmill'],
                        '+': ['Clock Yourself Foot/Hand Taps / Blaze Pod Square', 'Walking with Foam Ball Balance Carry']
                    }
                },
                'C': {
                    criteria: '1.0-1.1 m/s',
                    exercises: {
                        '-': ['Double Dumbbell Heel Raises', 'Forward/Backward Walking at Counter'],
                        'main': ['Exaggerated Arm Swing Walking', 'Resistance Band Walking'],
                        '+': ['Blaze Pod Shuttle Hand Taps Counter', 'Walking with Foam Carry']
                    }
                },
                'D': {
                    criteria: '0.9-1.0 m/s',
                    exercises: {
                        '-': ['Double Leg Heel Raises', 'Forward/Backward Step Through Weight shifts'],
                        'main': ['Heel to Toe Roll Through Stepping', 'Tray Table Walking Pushes'],
                        '+': ['Clock Yourself / Blaze Pods Standing Foot Taps', 'Walking with Ball Carry']
                    }
                },
                'F': {
                    criteria: '< 0.9 m/s',
                    exercises: {
                        '-': ['Seated Dumbbell Heel Raises', 'Standing Forward/Backward Weight Shifts'],
                        'main': ['Seated Quick Marching', 'Sit/Standing Resisted Tray Table Pushes'],
                        '+': ['Clock Yourself / Blaze Pods Seated Foot Taps', 'Walking with Purse Carry']
                    }
                }
            },
            sixMinWalk: {
                'A': {
                    criteria: '> 575 m',
                    exercises: {
                        '-': ['Walking Lunges', 'Weighted Front Press Hold Marching'],
                        'main': ['3 x 120" Treadmill Intervals at Stretch Pace (60 second preferred pace)', 'Elliptical with 60" speed push intervals (6-7 minutes)'],
                        '+': ['10-Minute Standing AMRAP Circuit', 'ABCs with Category Naming in Clinic with Directional Commands']
                    }
                },
                'B': {
                    criteria: '525 - 575 m',
                    exercises: {
                        '-': ['Split Lunges', 'Standing Dead Bug Marching'],
                        'main': ['6 x 60" Treadmill Intervals at Stretch Pace (60 second preferred pace)', 'Elliptical with 30" speed push intervals (6-7 minutes)'],
                        '+': ['6-Minute Standing AMRAP Circuit', 'Alternating ABC Post-It Search in Clinic with Walking Drills']
                    }
                },
                'C': {
                    criteria: '475 - 525 m',
                    exercises: {
                        '-': ['Lunges', 'Wall/Incline Mountain Climbers'],
                        'main': ['6 x 30" Treadmill Intervals at Stretch Pace (30 second standing rest breaks)', 'Biking with 30" RPM push intervals (6-7 minutes)'],
                        '+': ['8-Minute Standing EMOM Circuit', 'Reverse ABC Post-It Search in Clinic with Walking Drills']
                    }
                },
                'D': {
                    criteria: '425 - 475 m',
                    exercises: {
                        '-': ['Quarter Lunges', 'Single UE Assisted Marching'],
                        'main': ['6 x 45" Treadmill Intervals at Preferred Pace (30 second standing rest breaks)', 'Biking for 2-3 minute Bouts (2-3 Bouts)'],
                        '+': ['6-Minute Standing EMOM Circuit', 'ABC Post-It Search on One Wall with Broad Category Naming']
                    }
                },
                'F': {
                    criteria: '< 425 m',
                    exercises: {
                        '-': ['Staggered Stance STS', 'Counter Assisted Cone Taps'],
                        'main': ['6 x 30" Treadmill Intervals at Preferred Pace (30 second standing rest breaks)', 'Seated Step Taps for 30-60" Bouts (2-3 Bouts)'],
                        '+': ['6-Minute Seated EMOM Circuit', 'Standing ABC Post-It Search on One Wall']
                    }
                }
            },
            gripStrength: {
                'A': {
                    criteria: '> 90 lbs',
                    exercises: {
                        '-': ['Wrist Flexion/Extension Barbell Curls', 'TRX Row'],
                        'main': ['Farmer\'s Carries', 'Plate Holds'],
                        '+': ['Bar Hangs (optional pull progressions)', 'Kettlebell Bottom Up Carry']
                    }
                },
                'B': {
                    criteria: '71-90 lbs',
                    exercises: {
                        '-': ['Wrist Flexion/Extension Dumbbell Curls', 'Incline Row (Bar)'],
                        'main': ['Farmer\'s Hold Marches', 'Foam Pad/Small Weight Plate Holds'],
                        '+': ['Toe Touch Bar Hangs', 'Dumbbell/Kettlebell Waiter\'s Carry']
                    }
                },
                'C': {
                    criteria: '61-70 lbs',
                    exercises: {
                        '-': ['Wrist Flexion/Extension Resistance Bar/Band', 'Mid Row Band/Weight'],
                        'main': ['Farmer\'s Hold STS / Weight Shifts', 'Book Holds'],
                        '+': ['Partial Weight Bar Hangs', 'Dumbbell/Kettlebell Overhead Press']
                    }
                },
                'D': {
                    criteria: '51-60 lbs',
                    exercises: {
                        '-': ['Wrist Flexion/Extension Light Dumbbell Curls', 'Bent Over Row'],
                        'main': ['Resistance Bar Twists', 'Ball Squeeze Holds'],
                        '+': ['Bar Hang Squats', 'Dumbbell Biceps Curl/Kettlebell Rack']
                    }
                },
                'F': {
                    criteria: '< 50 lbs',
                    exercises: {
                        '-': ['Wrist Flexion/Extension Dowel Curls', 'Sit/Standing Band Row'],
                        'main': ['Towel Grips/Twists', 'Putty Squeezes'],
                        '+': ['Lat Pull Down (Band or Pulley)', 'Light Weight Biceps Curls']
                    }
                }
            },
            sitToStand: {
                'A': {
                    criteria: '> 15 stands',
                    exercises: {
                        '-': ['Single Leg Bridges', 'Weighted Squat Holds'],
                        'main': ['Resistance Band Power Squat Touches', 'Kettle Bell Dead Lifts'],
                        '+': ['Quick Chair Squat Touches', 'Coordinate to Music and/OR Add in VOR x 1']
                    }
                },
                'B': {
                    criteria: '13-15 stands',
                    exercises: {
                        '-': ['Marching Bridges', 'Wall Squats with Weights'],
                        'main': ['Resistance Band Power STS', 'Dowel/Light Weight Deadlifts - Full Distance'],
                        '+': ['Quick Quarter Squats', 'Coordinate to Music OR Add in Saccade Column Jumps Reading']
                    }
                },
                'C': {
                    criteria: '10 -12 stands',
                    exercises: {
                        '-': ['Resistance Band/Weighted Bridges', 'Wall Squats'],
                        'main': ['Tempo STS (Quick Up, Slow Down)', 'Dowel/Light Weight Deadlifts - Half Distance'],
                        '+': ['Quick Quarter Squat Touches to Table/Box', 'Coordinate to Music OR Add in Saccade Column Jumps Reading']
                    }
                },
                'D': {
                    criteria: '7-9 stands',
                    exercises: {
                        '-': ['Bridges', 'Quarter Wall Squats'],
                        'main': ['STS with Resistance Band Pulls', 'Resistance Band Counter Supported Deadlifts'],
                        '+': ['Quick Mini Squats - Butt Touches to Wall', 'Coordinate to Music OR Add in Hart Chart Reading']
                    }
                },
                'F': {
                    criteria: '< 7 stands',
                    exercises: {
                        '-': ['LE Elevated Bridges', 'Weighted Perched Sitting Holds'],
                        'main': ['Eccentric STS (Normal Up, Weighted Down)', 'Perched Sitting Band Deadlifts'],
                        '+': ['Quick Counter Supported Knee Bends/Pulses', 'Coordinate to Music OR Add in Hart Chart Reading']
                    }
                }
            },
            singleLegBalance: {
                'A': {
                    criteria: '> 27 seconds',
                    exercises: {
                        '-': ['Forward T (option for UE support)', 'Full Side Plank with/without Leg Lifts'],
                        'main': ['Single Leg Balance', 'Single Leg Balance + Head Turns/Nods'],
                        '+': ['Single Leg Balance + Eyes Closed', 'Single Leg Balance with Clock Taps/ Ball Toss']
                    }
                },
                'B': {
                    criteria: '20-27 seconds',
                    exercises: {
                        '-': ['Slider Lunge', 'Wall/Knee Side Plank Leg Lifts'],
                        'main': ['Single Leg Tripod', 'Tandem + Head Turns/Nods'],
                        '+': ['Tandem + Eyes Closed', 'Tandem Ball Toss/Bounce Pass (+ Backwards Spelling)']
                    }
                },
                'C': {
                    criteria: '10 - 19 seconds',
                    exercises: {
                        '-': ['LAQ Medicine Ball Holds', 'Wall/Knee Side Plank'],
                        'main': ['Counter Support Single Leg Holds', 'Stride Tandem + Head Turns/Nods'],
                        '+': ['Stride Tandem + Eyes Closed', 'Stride Tandem Ball Toss/Bounce Pass (+ Backwards Spelling)']
                    }
                },
                'D': {
                    criteria: '5 - 10 seconds',
                    exercises: {
                        '-': ['Standing TKE Ball presses', 'Hip Hikes Standing Hip Abduction'],
                        'main': ['Single Leg + CL LE Toe Tap Hold on Step', 'NBOS + Head Turns/Nods'],
                        '+': ['NBOS + Eyes Closed', 'NBOS Ball Toss/Bounce Pass (+ Backwards Spelling)']
                    }
                },
                'F': {
                    criteria: '< 5 seconds',
                    exercises: {
                        '-': ['Prone TKE Hooklying SLR', 'Standing UE on Counter Hip Abduction Slides'],
                        'main': ['Single Leg + CL LE Toe Tap Hold on Step with UE', 'WBOS + Head Turns/Nods (with UE)'],
                        '+': ['WBOS + Eyes Closed', 'WBOS Ball Toss/Bounce Pass (+ Backwards Spelling)']
                    }
                }
            }
        };

        // CLSA normative data (abbreviated for space)
        const normativeData = {
            tug: {
                male: {
                    '45-54': { mean: 8.2, sd: 1.4, p5: 6.4, p25: 7.4, p50: 8.0, p75: 8.7, p95: 10.5, n: 3421 },
                    '55-64': { mean: 8.7, sd: 1.6, p5: 6.7, p25: 7.8, p50: 8.5, p75: 9.2, p95: 11.4, n: 4892 },
                    '65-74': { mean: 9.3, sd: 1.9, p5: 7.0, p25: 8.3, p50: 9.1, p75: 9.9, p95: 12.5, n: 6234 }
                },
                female: {
                    '45-54': { mean: 8.5, sd: 1.5, p5: 6.6, p25: 7.7, p50: 8.3, p75: 9.0, p95: 10.9, n: 3687 },
                    '55-64': { mean: 9.1, sd: 1.7, p5: 7.0, p25: 8.1, p50: 8.9, p75: 9.6, p95: 11.9, n: 5234 },
                    '65-74': { mean: 9.8, sd: 2.1, p5: 7.3, p25: 8.7, p50: 9.5, p75: 10.4, p95: 13.3, n: 6891 }
                }
            },
            gaitSpeed: {
                male: {
                    '45-54': { mean: 1.38, sd: 0.19, p5: 1.08, p25: 1.27, p50: 1.37, p75: 1.47, p95: 1.69, n: 3421 },
                    '55-64': { mean: 1.34, sd: 0.20, p5: 1.03, p25: 1.23, p50: 1.33, p75: 1.44, p95: 1.65, n: 4892 },
                    '65-74': { mean: 1.28, sd: 0.22, p5: 0.95, p25: 1.16, p50: 1.27, p75: 1.39, p95: 1.61, n: 6234 }
                },
                female: {
                    '45-54': { mean: 1.31, sd: 0.18, p5: 1.02, p25: 1.21, p50: 1.30, p75: 1.40, p95: 1.60, n: 3687 },
                    '55-64': { mean: 1.27, sd: 0.19, p5: 0.97, p25: 1.17, p50: 1.26, p75: 1.36, p95: 1.56, n: 5234 },
                    '65-74': { mean: 1.21, sd: 0.21, p5: 0.89, p25: 1.10, p50: 1.20, p75: 1.31, p95: 1.53, n: 6891 }
                }
            },
            moca: {
                all: {
                    '45-54': { mean: 27.9, sd: 1.7, p5: 24.7, p25: 27.1, p50: 28.0, p75: 28.8, p95: 30.0, n: 7108 },
                    '55-64': { mean: 27.5, sd: 1.9, p5: 24.1, p25: 26.8, p50: 27.6, p75: 28.4, p95: 30.0, n: 10126 },
                    '65-74': { mean: 26.9, sd: 2.2, p5: 22.9, p25: 26.1, p50: 27.0, p75: 28.0, p95: 30.0, n: 13125 }
                }
            }
        };

        // Helper functions
        function getAgeGroup(age) {
            if (age >= 65) return '65-74';
            if (age >= 55) return '55-64';
            return '45-54';
        }

        function calculatePercentile(value, norms) {
            if (value <= norms.p5) return Math.max(1, Math.round(5 * (value / norms.p5)));
            if (value <= norms.p25) return Math.round(5 + 20 * ((value - norms.p5) / (norms.p25 - norms.p5)));
            if (value <= norms.p50) return Math.round(25 + 25 * ((value - norms.p25) / (norms.p50 - norms.p25)));
            if (value <= norms.p75) return Math.round(50 + 25 * ((value - norms.p50) / (norms.p75 - norms.p50)));
            if (value <= norms.p95) return Math.round(75 + 20 * ((value - norms.p75) / (norms.p95 - norms.p75)));
            return Math.min(99, Math.round(95 + 4 * ((value - norms.p95) / (norms.p95 * 0.1))));
        }

        function getGrade(percentile, isReversed = false) {
            const effectivePercentile = isReversed ? 100 - percentile : percentile;
            if (effectivePercentile >= 95) return 'A+';
            if (effectivePercentile >= 84) return 'A';
            if (effectivePercentile >= 75) return 'B+';
            if (effectivePercentile >= 50) return 'B';
            if (effectivePercentile >= 25) return 'C+';
            if (effectivePercentile >= 16) return 'C';
            if (effectivePercentile >= 5) return 'D';
            return 'F';
        }

        // Katie's grading criteria for physical tests
        function getKatieGrade(testName, value) {
            const criteria = {
                'TUG Test': {
                    'A': { max: 8 },
                    'B': { min: 8, max: 10 },
                    'C': { min: 10, max: 13 },
                    'D': { min: 14, max: 16 },
                    'F': { min: 16 }
                },
                'Gait Speed': {
                    'A': { min: 1.3 },
                    'B': { min: 1.1, max: 1.3 },
                    'C': { min: 1.0, max: 1.1 },
                    'D': { min: 0.9, max: 1.0 },
                    'F': { max: 0.9 }
                },
                '6-Min Walk': {
                    'A': { min: 575 },
                    'B': { min: 525, max: 575 },
                    'C': { min: 475, max: 525 },
                    'D': { min: 425, max: 475 },
                    'F': { max: 425 }
                },
                'Grip Strength': {
                    'A': { min: 90 },
                    'B': { min: 71, max: 90 },
                    'C': { min: 61, max: 71 },
                    'D': { min: 51, max: 61 },
                    'F': { max: 51 }
                },
                'Sit-to-Stand': {
                    'A': { min: 15 },
                    'B': { min: 13, max: 15 },
                    'C': { min: 10, max: 13 },
                    'D': { min: 7, max: 10 },
                    'F': { max: 7 }
                },
                'Single-Leg Balance': {
                    'A': { min: 27 },
                    'B': { min: 20, max: 27 },
                    'C': { min: 10, max: 20 },
                    'D': { min: 5, max: 10 },
                    'F': { max: 5 }
                }
            };

            const testCriteria = criteria[testName];
            if (!testCriteria) return 'C'; // default for unknown tests

            for (const [grade, range] of Object.entries(testCriteria)) {
                const hasMin = range.min !== undefined;
                const hasMax = range.max !== undefined;
                
                if (hasMin && hasMax) {
                    if (value >= range.min && value < range.max) return grade;
                } else if (hasMin && !hasMax) {
                    if (value >= range.min) return grade;
                } else if (!hasMin && hasMax) {
                    if (value < range.max) return grade;
                }
            }
            
            return 'C'; // default fallback
        }

        // Convert Katie's grades to percentile equivalents for domain scoring
        function gradeToPercentile(grade) {
            const gradeMap = {
                'A': 90,
                'B': 70,
                'C': 50,
                'D': 30,
                'F': 10
            };
            return gradeMap[grade] || 50;
        }

        // MoCA grading based on cognitive impairment risk levels
        function getMocaGrade(score) {
            if (score >= 26) return 'A'; // Normal cognitive function
            if (score >= 22) return 'B'; // Mild cognitive impairment risk
            if (score >= 17) return 'C'; // Moderate cognitive impairment
            return 'D'; // High cognitive impairment risk
        }

        function getMocaRiskLevel(score) {
            if (score >= 26) return 'Normal cognitive function';
            if (score >= 22) return 'Mild cognitive impairment risk';
            if (score >= 17) return 'Moderate cognitive impairment';
            return 'High cognitive impairment risk';
        }

        function getGradeColor(grade) {
            const colors = {
                'A+': 'bg-emerald-100 text-emerald-800 border-emerald-200',
                'A': 'bg-green-100 text-green-800 border-green-200',
                'B+': 'bg-lime-100 text-lime-800 border-lime-200',
                'B': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                'C+': 'bg-amber-100 text-amber-800 border-amber-200',
                'C': 'bg-orange-100 text-orange-800 border-orange-200',
                'D': 'bg-red-100 text-red-800 border-red-200',
                'F': 'bg-red-200 text-red-900 border-red-300'
            };
            return colors[grade] || 'bg-gray-100 text-gray-800 border-gray-200';
        }

        function getNeurotrakClassification(score) {
            const numScore = parseFloat(score);
            if (isNaN(numScore) || numScore < 0) return 'Low';
            if (numScore >= 17) return 'Normal';
            if (numScore >= 8) return 'Borderline';
            return 'Low';
        }

        function getNeurotrakGrade(symbolScore, pathScore) {
            if (!symbolScore || !pathScore) return 'N/A';
            
            const symbolClass = getNeurotrakClassification(symbolScore);
            const pathClass = getNeurotrakClassification(pathScore);

            if (symbolClass === 'Normal' && pathClass === 'Normal') return 'A';
            if ((symbolClass === 'Normal' && pathClass === 'Borderline') ||
                (symbolClass === 'Borderline' && pathClass === 'Normal') ||
                (symbolClass === 'Borderline' && pathClass === 'Borderline')) return 'B';
            if ((symbolClass === 'Borderline' && pathClass === 'Low') ||
                (symbolClass === 'Low' && pathClass === 'Borderline')) return 'C';
            if (symbolClass === 'Low' && pathClass === 'Low') return 'D';
            return 'C';
        }

        function getRiskLevel(score) {
            if (score >= 80) return { level: 'Very Low', color: 'text-emerald-600' };
            if (score >= 65) return { level: 'Low', color: 'text-green-600' };
            if (score >= 45) return { level: 'Moderate', color: 'text-yellow-600' };
            if (score >= 25) return { level: 'High', color: 'text-orange-600' };
            return { level: 'Very High', color: 'text-red-600' };
        }

        // Map test name to exercise progression key
        function getExerciseKey(testName) {
            const mapping = {
                'TUG Test': 'tug',
                'Gait Speed': 'gaitSpeed',
                '6-Min Walk': 'sixMinWalk',
                'Grip Strength': 'gripStrength',
                'Sit-to-Stand': 'sitToStand',
                'Single-Leg Balance': 'singleLegBalance'
            };
            return mapping[testName] || null;
        }

        // Map simple letter grade to exercise grade
        function mapToExerciseGrade(grade) {
            // Convert A+, B+, C+ to A, B, C respectively
            const simpleGrade = grade.replace('+', '');
            // Make sure we have a valid grade
            return ['A', 'B', 'C', 'D', 'F'].includes(simpleGrade) ? simpleGrade : 'C';
        }

        function validateForm() {
            const requiredFields = [
                'patientName', 'patientAge', 'patientGender', 'tugTime', 'gaitSpeed', 
                'sixMinWalk', 'gripStrength', 'sitToStand', 'singleLegBalance', 
                'mocaScore', 'neurotrakSymbol', 'neurotrakPath'
            ];
            
            const isValid = requiredFields.every(field => {
                const element = document.getElementById(field);
                return element && element.value.trim() !== '';
            });

            const calculateBtn = document.getElementById('calculateBtn');
            if (isValid) {
                calculateBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                calculateBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
                calculateBtn.disabled = false;
            } else {
                calculateBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                calculateBtn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
                calculateBtn.disabled = true;
            }
        }

        function calculateResults() {
            // Collect patient data
            patientData = {
                name: document.getElementById('patientName').value,
                age: parseInt(document.getElementById('patientAge').value),
                gender: document.getElementById('patientGender').value,
                tugTime: parseFloat(document.getElementById('tugTime').value),
                gaitSpeed: parseFloat(document.getElementById('gaitSpeed').value),
                sixMinWalk: parseInt(document.getElementById('sixMinWalk').value),
                gripStrength: parseFloat(document.getElementById('gripStrength').value),
                sitToStand: parseInt(document.getElementById('sitToStand').value),
                singleLegBalance: parseFloat(document.getElementById('singleLegBalance').value),
                mocaScore: parseInt(document.getElementById('mocaScore').value),
                neurotrakSymbol: document.getElementById('neurotrakSymbol').value,
                neurotrakPath: document.getElementById('neurotrakPath').value
            };

            const ageGroup = getAgeGroup(patientData.age);
            
            // Calculate grades using Katie's criteria for physical tests
            const tugGrade = getKatieGrade('TUG Test', patientData.tugTime);
            const gaitGrade = getKatieGrade('Gait Speed', patientData.gaitSpeed);
            const walkGrade = getKatieGrade('6-Min Walk', patientData.sixMinWalk);
            const gripGrade = getKatieGrade('Grip Strength', patientData.gripStrength);
            const stsGrade = getKatieGrade('Sit-to-Stand', patientData.sitToStand);
            const balanceGrade = getKatieGrade('Single-Leg Balance', patientData.singleLegBalance);

            // Calculate cognitive grades
            const mocaGrade = getMocaGrade(patientData.mocaScore);
            const neurotrakGrade = getNeurotrakGrade(patientData.neurotrakSymbol, patientData.neurotrakPath);

            // Convert all grades to percentile equivalents for domain calculations
            const tugPercentile = 100 - gradeToPercentile(tugGrade); // Reversed for TUG (lower is better)
            const gaitPercentile = gradeToPercentile(gaitGrade);
            const walkPercentile = gradeToPercentile(walkGrade);
            const gripPercentile = gradeToPercentile(gripGrade);
            const stsPercentile = gradeToPercentile(stsGrade);
            const balancePercentile = gradeToPercentile(balanceGrade);
            const mocaPercentile = gradeToPercentile(mocaGrade);
            const neurotrakPercentile = neurotrakGrade === 'A' ? 85 : neurotrakGrade === 'B' ? 65 : neurotrakGrade === 'C' ? 35 : 15;

            // Build test results array
            const testResults = [
                { name: 'TUG Test', value: patientData.tugTime, unit: 'sec', percentile: tugPercentile, grade: tugGrade, isKatieGraded: true },
                { name: 'Gait Speed', value: patientData.gaitSpeed, unit: 'm/s', percentile: gaitPercentile, grade: gaitGrade, isKatieGraded: true },
                { name: '6-Min Walk', value: patientData.sixMinWalk, unit: 'm', percentile: walkPercentile, grade: walkGrade, isKatieGraded: true },
                { name: 'Grip Strength', value: patientData.gripStrength, unit: 'lbs', percentile: gripPercentile, grade: gripGrade, isKatieGraded: true },
                { name: 'Sit-to-Stand', value: patientData.sitToStand, unit: 'reps', percentile: stsPercentile, grade: stsGrade, isKatieGraded: true },
                { name: 'Single-Leg Balance', value: patientData.singleLegBalance, unit: 'sec', percentile: balancePercentile, grade: balanceGrade, isKatieGraded: true },
                { name: 'MoCA Score', value: patientData.mocaScore, unit: '/30', percentile: mocaPercentile, grade: mocaGrade, isMoca: true },
                { name: 'Neurotrak Assessment', value: `${patientData.neurotrakSymbol} / ${patientData.neurotrakPath}`, unit: 'Symbol/Path', percentile: neurotrakPercentile, grade: neurotrakGrade, isNeurotrak: true }
            ];

            // Calculate domain scores using the percentile equivalents
            const mobilityScore = Math.round((gaitPercentile + walkPercentile + tugPercentile) / 3);
            const strengthScore = Math.round((gripPercentile + stsPercentile) / 2);
            const balanceScore = Math.round(balancePercentile);
            const cognitiveScore = Math.round((mocaPercentile + neurotrakPercentile) / 2);

            const compositeScore = Math.round((mobilityScore * 0.3) + (strengthScore * 0.25) + (balanceScore * 0.25) + (cognitiveScore * 0.2));

            results = {
                testResults,
                compositeScore,
                riskInfo: getRiskLevel(compositeScore),
                domainScores: { mobility: mobilityScore, strength: strengthScore, balance: balanceScore, cognitive: cognitiveScore },
                ageGroup,
                gender: patientData.gender
            };

            displayResults();
        }

        function displayResults() {
            // Hide form and show results
            document.getElementById('assessmentForm').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');

            // Update result header
            document.getElementById('resultName').textContent = patientData.name;
            document.getElementById('resultAge').textContent = patientData.age;
            document.getElementById('resultGender').textContent = patientData.gender.charAt(0).toUpperCase() + patientData.gender.slice(1);
            document.getElementById('resultAgeGroup').textContent = results.ageGroup;
            document.getElementById('compositeScore').textContent = results.compositeScore;

            // Update risk level
            const riskLevel = document.getElementById('riskLevel');
            const riskIcon = document.getElementById('riskIcon');
            riskLevel.textContent = `${results.riskInfo.level} Risk`;
            riskLevel.className = `text-lg font-medium ${results.riskInfo.color}`;
            riskIcon.className = `w-8 h-8 mr-3 ${results.riskInfo.color}`;

            // Update domain scores
            const domainScoresDiv = document.getElementById('domainScores');
            domainScoresDiv.innerHTML = '';
            Object.entries(results.domainScores).forEach(([domain, score]) => {
                const colorClass = score >= 75 ? 'bg-green-500' : score >= 50 ? 'bg-yellow-500' : score >= 25 ? 'bg-orange-500' : 'bg-red-500';
                domainScoresDiv.innerHTML += `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600">${score}</div>
                        <div class="text-sm font-medium text-gray-700 capitalize">${domain}</div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div class="h-2 rounded-full ${colorClass}" style="width: ${score}%"></div>
                        </div>
                    </div>
                `;
            });

            // Update test results table
            const tableBody = document.getElementById('testResultsTableBody');
            tableBody.innerHTML = '';
            results.testResults.forEach((test, index) => {
                const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                const gradeColorClass = getGradeColor(test.grade);
                
                let interpretation = '';
                if (test.isNeurotrak) {
                    interpretation = `${getNeurotrakClassification(patientData.neurotrakSymbol)} / ${getNeurotrakClassification(patientData.neurotrakPath)} classification`;
                } else if (test.isKatieGraded) {
                    interpretation = `Performance-based criteria (LivLuv'd Framework)`;
                } else if (test.isMoca) {
                    interpretation = `${getMocaRiskLevel(patientData.mocaScore)}`;
                } else {
                    interpretation = `Score-based cognitive assessment criteria`;
                }
                
                const percentileDisplay = test.isKatieGraded ? 'Performance' : (test.isNeurotrak ? 'Clinical' : (test.isMoca ? 'Cognitive' : 'Score'));
                
                tableBody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${test.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${test.value} ${test.unit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${percentileDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${gradeColorClass}">${test.grade}</span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${interpretation}</td>
                    </tr>
                `;
            });

            // Generate prescriptions
            generatePrescriptions();
        }

        function generatePrescriptions() {
            const prescriptionsContent = document.getElementById('prescriptionsContent');
            const { domainScores, compositeScore } = results;
            
            let prescriptionsHTML = '';

            // Katie's Exercise Progressions
            prescriptionsHTML += `
                <div class="border-l-4 border-purple-500 pl-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-semibold text-gray-900 text-lg">Personalized Exercise Progressions</h4>
                        <span class="px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border-purple-200">LivLuv'd Framework</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Specific exercise prescriptions based on your test grades:</p>
            `;

            // Add exercises for each physical test (excluding cognitive tests)
            const physicalTests = results.testResults.filter(test => !test.isNeurotrak && test.name !== 'MoCA Score');
            
            physicalTests.forEach(test => {
                const exerciseKey = getExerciseKey(test.name);
                if (exerciseKey && exerciseProgressions[exerciseKey]) {
                    const exerciseGrade = mapToExerciseGrade(test.grade);
                    const exercises = exerciseProgressions[exerciseKey][exerciseGrade];
                    
                    if (exercises) {
                        prescriptionsHTML += `
                            <div class="bg-purple-50 rounded-lg p-4 mb-4">
                                <h5 class="font-medium text-gray-900 mb-2">${test.name} (Grade: ${test.grade})</h5>
                                <div class="space-y-2">
                        `;
                        
                        if (exercises.exercises['-'] && exercises.exercises['-'].length > 0) {
                            prescriptionsHTML += `
                                <div class="pl-4">
                                    <span class="text-xs font-medium text-purple-700">Foundation Exercises:</span>
                                    <ul class="list-disc list-inside text-sm text-gray-700 mt-1">
                                        ${exercises.exercises['-'].map(ex => `<li>${ex}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                        
                        if (exercises.exercises['main'] && exercises.exercises['main'].length > 0) {
                            prescriptionsHTML += `
                                <div class="pl-4">
                                    <span class="text-xs font-medium text-purple-700">Primary Exercises:</span>
                                    <ul class="list-disc list-inside text-sm text-gray-700 mt-1">
                                        ${exercises.exercises['main'].map(ex => `<li>${ex}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                        
                        if (exercises.exercises['+'] && exercises.exercises['+'].length > 0) {
                            prescriptionsHTML += `
                                <div class="pl-4">
                                    <span class="text-xs font-medium text-purple-700">Advanced Progressions:</span>
                                    <ul class="list-disc list-inside text-sm text-gray-700 mt-1">
                                        ${exercises.exercises['+'].map(ex => `<li>${ex}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                        
                        prescriptionsHTML += `
                                </div>
                            </div>
                        `;
                    }
                }
            });

            prescriptionsHTML += `
                    <div class="mt-4 p-3 bg-purple-50 rounded-lg">
                        <p class="text-xs text-purple-800"><strong>Exercise Guidelines:</strong> Start with Foundation exercises, progress to Primary when comfortable, and advance to Progressions as strength and balance improve. Perform 2-3 sets of each exercise, 3-4 days per week.</p>
                    </div>
                </div>
            `;

            // Original Evidence-Based Prescriptions
            // Mobility Enhancement
            if (domainScores.mobility < 65) {
                const priority = domainScores.mobility < 25 ? 'Critical' : domainScores.mobility < 45 ? 'High' : 'Moderate';
                const priorityColor = priority === 'Critical' ? 'bg-red-100 text-red-800 border-red-200' : 
                                   priority === 'High' ? 'bg-orange-100 text-orange-800 border-orange-200' : 
                                   'bg-yellow-100 text-yellow-800 border-yellow-200';
                
                prescriptionsHTML += `
                    <div class="border-l-4 border-blue-500 pl-4">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold text-gray-900 text-lg">Mobility Enhancement</h4>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${priorityColor}">${priority} Priority</span>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-medium text-gray-900 mb-2">Aerobic Exercise (WHO 2020 Guidelines)</h5>
                            <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                                <li>WHO Guidelines: 150-300 min/week moderate intensity, 5-6 days/week</li>
                                <li>Target heart rate: ${Math.round((220 - patientData.age) * 0.64)}-${Math.round((220 - patientData.age) * 0.76)} bpm (moderate intensity)</li>
                                <li>Progress duration by 10% weekly until target achieved</li>
                                <li>Varied activities: Walking, swimming, cycling, dancing for adherence</li>
                            </ul>
                        </div>
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-xs text-blue-800"><strong>Evidence:</strong> WHO 2020 guidelines + Sherrington et al. (2019): Structured programs show 20-30% gait speed improvement</p>
                        </div>
                    </div>
                `;
            }

            // Strength Building
            if (domainScores.strength < 65) {
                const priority = domainScores.strength < 25 ? 'Critical' : domainScores.strength < 45 ? 'High' : 'Moderate';
                const priorityColor = priority === 'Critical' ? 'bg-red-100 text-red-800 border-red-200' : 
                                   priority === 'High' ? 'bg-orange-100 text-orange-800 border-orange-200' : 
                                   'bg-yellow-100 text-yellow-800 border-yellow-200';
                
                prescriptionsHTML += `
                    <div class="border-l-4 border-blue-500 pl-4">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold text-gray-900 text-lg">Strength Building</h4>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${priorityColor}">${priority} Priority</span>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-medium text-gray-900 mb-2">Resistance Training (Specific Intensities)</h5>
                            <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                                <li>Frequency: ${domainScores.strength < 45 ? '2-3 sessions/week, non-consecutive days' : '3-4 sessions/week'}</li>
                                <li>Intensity: ${domainScores.strength < 25 ? '40-60% 1RM (12-20 reps)' : domainScores.strength < 45 ? '60-70% 1RM (8-12 reps)' : '65-75% 1RM (6-12 reps)'} for optimal strength gains</li>
                                <li>Volume: 2-4 sets per exercise, 6-8 exercises covering major muscle groups</li>
                                <li>Progression: Increase load 5-10% when upper rep range achieved with good form</li>
                            </ul>
                        </div>
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-xs text-blue-800"><strong>Evidence:</strong> Peterson et al. (2011): Progressive resistance at 65-75% 1RM shows 32% strength gains in older adults</p>
                        </div>
                    </div>
                `;
            }

            // Cognitive Enhancement
            if (domainScores.cognitive < 65) {
                const priority = domainScores.cognitive < 25 ? 'Critical' : domainScores.cognitive < 45 ? 'High' : 'Moderate';
                const priorityColor = priority === 'Critical' ? 'bg-red-100 text-red-800 border-red-200' : 
                                   priority === 'High' ? 'bg-orange-100 text-orange-800 border-orange-200' : 
                                   'bg-yellow-100 text-yellow-800 border-yellow-200';
                
                prescriptionsHTML += `
                    <div class="border-l-4 border-blue-500 pl-4">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold text-gray-900 text-lg">Cognitive Enhancement</h4>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${priorityColor}">${priority} Priority</span>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-medium text-gray-900 mb-2">Structured Cognitive Training</h5>
                            <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                                <li>Multi-domain approach: Working memory, processing speed, executive function</li>
                                <li>Adaptive difficulty: Programs adjust to performance level (BrainHQ, CogniFit)</li>
                                <li>Frequency: 3-5 sessions/week, 30-45 minutes per session</li>
                                <li>Dual-task training: 80% cognitive + 80% physical load, progress to 90%+</li>
                            </ul>
                        </div>
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-xs text-blue-800"><strong>Evidence:</strong> ACTIVE trial: Multi-domain cognitive training benefits persist 10+ years. Novel learning creates cognitive reserve.</p>
                        </div>
                    </div>
                `;
            }

            // Nutritional Optimization
            prescriptionsHTML += `
                <div class="border-l-4 border-blue-500 pl-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-semibold text-gray-900 text-lg">Nutritional Optimization</h4>
                        <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border-blue-200">Essential Priority</span>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-medium text-gray-900 mb-2">Protein for Sarcopenia Prevention</h5>
                        <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                            <li>Daily protein target: 84-112g (1.2-1.6 g/kg body weight)</li>
                            <li>Meal distribution: 25-30g protein per meal for optimal muscle protein synthesis</li>
                            <li>High-quality sources: Lean meats, fish, eggs, dairy, legumes, quinoa</li>
                            <li>Leucine-rich foods: Chicken, fish, eggs, dairy (trigger muscle building)</li>
                        </ul>
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <p class="text-xs text-blue-800"><strong>Evidence:</strong> PREDIMED-Plus: Mediterranean diet reduces cognitive decline by 20%. Protein targets based on sarcopenia prevention research.</p>
                    </div>
                </div>
            `;

            prescriptionsContent.innerHTML = prescriptionsHTML;
        }

        function exportToCSV() {
            const csvData = [
                'Timestamp,Name,Age,Gender,TUG_Time,Gait_Speed,6Min_Walk,Grip_Strength,Sit_to_Stand,Balance,MoCA,Neurotrak_Symbol,Neurotrak_Path,Composite_Score,Risk_Level',
                `${new Date().toISOString()},${patientData.name},${patientData.age},${patientData.gender},${patientData.tugTime},${patientData.gaitSpeed},${patientData.sixMinWalk},${patientData.gripStrength},${patientData.sitToStand},${patientData.singleLegBalance},${patientData.mocaScore},${patientData.neurotrakSymbol},${patientData.neurotrakPath},${results.compositeScore},${results.riskInfo.level}`
            ].join('\n');

            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `brain_health_assessment_${patientData.name}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Sharing Functions
        function copyCalculatorLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                const msg = document.getElementById('linkCopiedMsg');
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 3000);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = window.location.href;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const msg = document.getElementById('linkCopiedMsg');
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 3000);
            });
        }

        function shareViaEmail() {
            const subject = 'LivLuv\'d Brain Health Calculator';
            const body = `Hi,\n\nI wanted to share this comprehensive brain health assessment tool with you:\n\n${window.location.href}\n\nThe LivLuv'd Brain Health Calculator provides evidence-based physical and cognitive assessments with personalized exercise prescriptions.\n\nBest regards`;
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function shareViaTwitter() {
            const text = 'Check out this comprehensive Brain Health Calculator with evidence-based assessments and personalized exercise prescriptions!';
            const url = window.location.href;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
        }

        function printResults() {
            // Create a new window with just the results for printing
            const printWindow = window.open('', '_blank');
            const resultsHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Brain Health Assessment - ${patientData.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .patient-info { background: #f5f5f5; padding: 15px; margin-bottom: 20px; }
                        .results-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
                        .domain-card { border: 1px solid #ddd; padding: 15px; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f5f5f5; }
                        .grade { padding: 4px 8px; border-radius: 4px; font-weight: bold; }
                        .grade-A { background: #dcfce7; color: #166534; }
                        .grade-B { background: #fef3c7; color: #92400e; }
                        .grade-C { background: #fed7aa; color: #c2410c; }
                        .grade-D { background: #fecaca; color: #dc2626; }
                        .grade-F { background: #fca5a5; color: #991b1b; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>LivLuv'd Brain Health Assessment</h1>
                        <p>Generated on ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <div class="patient-info">
                        <h3>Patient Information</h3>
                        <p><strong>Name:</strong> ${patientData.name}</p>
                        <p><strong>Age:</strong> ${patientData.age}</p>
                        <p><strong>Gender:</strong> ${patientData.gender}</p>
                        <p><strong>Composite Score:</strong> ${results.compositeScore}</p>
                        <p><strong>Risk Level:</strong> ${results.riskInfo.level} Risk</p>
                    </div>
                    
                    <div class="results-grid">
                        ${Object.entries(results.domainScores).map(([domain, score]) => `
                            <div class="domain-card">
                                <h4>${domain.charAt(0).toUpperCase() + domain.slice(1)}</h4>
                                <div style="font-size: 24px; font-weight: bold; color: #2563eb;">${score}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Test</th>
                                <th>Score</th>
                                <th>Grade</th>
                                <th>Interpretation</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.testResults.map(test => {
                                let interpretation = '';
                                if (test.isNeurotrak) {
                                    interpretation = `${getNeurotrakClassification(patientData.neurotrakSymbol)} / ${getNeurotrakClassification(patientData.neurotrakPath)} classification`;
                                } else if (test.isKatieGraded) {
                                    interpretation = `Performance-based criteria`;
                                } else if (test.isMoca) {
                                    interpretation = `${getMocaRiskLevel(patientData.mocaScore)}`;
                                }
                                return `
                                    <tr>
                                        <td>${test.name}</td>
                                        <td>${test.value} ${test.unit}</td>
                                        <td><span class="grade grade-${test.grade}">${test.grade}</span></td>
                                        <td>${interpretation}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(resultsHTML);
            printWindow.document.close();
            printWindow.print();
        }

        function copyResultsSummary() {
            const summary = `
LivLuv'd Brain Health Assessment Results
Patient: ${patientData.name}
Age: ${patientData.age} | Gender: ${patientData.gender}
Assessment Date: ${new Date().toLocaleDateString()}

OVERALL RESULTS:
• Composite Score: ${results.compositeScore}/100
• Risk Level: ${results.riskInfo.level} Risk

DOMAIN SCORES:
• Mobility: ${results.domainScores.mobility}/100
• Strength: ${results.domainScores.strength}/100
• Balance: ${results.domainScores.balance}/100
• Cognitive: ${results.domainScores.cognitive}/100

INDIVIDUAL TEST RESULTS:
${results.testResults.map(test => `• ${test.name}: ${test.value} ${test.unit} (Grade: ${test.grade})`).join('\n')}

Generated by LivLuv'd Brain Health Calculator
            `.trim();

            navigator.clipboard.writeText(summary).then(() => {
                const msg = document.getElementById('resultsCopiedMsg');
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 3000);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = summary;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const msg = document.getElementById('resultsCopiedMsg');
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 3000);
            });
        }

        function shareResultsViaEmail() {
            const subject = `Brain Health Assessment Results - ${patientData.name}`;
            const body = `
Hi,

Here are the brain health assessment results for ${patientData.name}:

OVERALL RESULTS:
• Composite Score: ${results.compositeScore}/100
• Risk Level: ${results.riskInfo.level} Risk

DOMAIN SCORES:
• Mobility: ${results.domainScores.mobility}/100
• Strength: ${results.domainScores.strength}/100
• Balance: ${results.domainScores.balance}/100
• Cognitive: ${results.domainScores.cognitive}/100

INDIVIDUAL TEST RESULTS:
${results.testResults.map(test => `• ${test.name}: ${test.value} ${test.unit} (Grade: ${test.grade})`).join('\n')}

Assessment Date: ${new Date().toLocaleDateString()}
Generated by LivLuv'd Brain Health Calculator

Best regards
            `.trim();

            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function resetForm() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('assessmentForm').classList.remove('hidden');
            
            // Reset all form fields
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => input.value = '');
            
            validateForm();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to all form inputs for validation
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', validateForm);
            });

            // Calculate button
            document.getElementById('calculateBtn').addEventListener('click', calculateResults);

            // Calculator sharing buttons
            document.getElementById('copyLinkBtn').addEventListener('click', copyCalculatorLink);
            document.getElementById('shareEmailBtn').addEventListener('click', shareViaEmail);
            document.getElementById('shareTwitterBtn').addEventListener('click', shareViaTwitter);

            // Results sharing and export buttons
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('printBtn').addEventListener('click', printResults);
            document.getElementById('shareResultsEmailBtn').addEventListener('click', shareResultsViaEmail);
            document.getElementById('copyResultsBtn').addEventListener('click', copyResultsSummary);

            // New assessment button
            document.getElementById('newAssessmentBtn').addEventListener('click', resetForm);

            // Initial validation
            validateForm();
        });
    </script>
</body>
</html>
